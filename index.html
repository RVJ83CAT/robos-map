<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Delitos con Tabla y Cartografías</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        .header-section { width: 100%; background-color: #355E3B; color: white; padding: 10px; text-align: center; }
        .header-section h1 { margin: 0; font-size: 24px; font-weight: bold; }
        .subtitle-section { font-size: 16px; margin: 5px 0; display: none; font-weight: bold; }
        .container { display: flex; flex-direction: row; gap: 10px; height: calc(100vh - 80px); margin-top: 10px; }
        #sidebar { 
            width: 12.5%; 
            height: 100%; 
            overflow-y: auto; 
            padding-left: 10px; 
            font-size: 12px; 
            position: absolute; 
            right: 0; 
            top: 80px; 
            background: #fff; 
            box-shadow: -2px 0 5px rgba(0,0,0,0.2); 
            transform: translateX(100%); 
            transition: transform 0.3s ease; 
            z-index: 1000; 
        }
        #sidebar.visible { transform: translateX(0); }
        #sidebar label, #sidebar input, #sidebar select, #sidebar button { font-size: 12px; }
        #sidebar button { padding: 8px 12px; }
        #main-content { width: 100%; display: flex; flex-direction: column; height: 100%; }
        .map-container { flex: 1; position: relative; }
        #map { height: 100%; width: 100%; }
        #map-loading { display: flex; align-items: center; justify-content: center; height: 100%; background: #f0f0f0; }
        .table-container { 
            width: 100%; 
            max-height: 200px; 
            background: #fff; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            overflow-y: auto; 
            margin-top: 10px; 
        }
        .drag-handle { 
            background: #e9ecef; 
            padding: 5px; 
            text-align: center; 
            font-weight: bold; 
            border-bottom: 1px solid #ccc; 
            margin: 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .form-container { margin: 10px 0; }
        .form-container label { display: block; margin: 5px 0; font-weight: bold; }
        .form-container input, .form-container select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .form-container input:invalid { border-color: #dc3545; }
        .form-container button { margin-top: 10px; padding: 10px 15px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; }
        .form-container button:hover { background-color: #0056b3; }
        .filter-container { display: flex; flex-direction: column; gap: 10px; }
        table { width: 100%; border-collapse: collapse; margin: 0; font-size: 8px; line-height: 1.0; background-color: #ffffff; table-layout: auto; border: 1px solid black; }
        th { background-color: #355E3B; border: 1px solid black; padding: 2px; text-align: center; font-weight: bold; color: #ffffff; }
        th[data-col="numero"] { cursor: default; user-select: none; }
        th:hover::after { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 4px; background: rgba(255, 255, 255, 0.2); }
        th.dragging { opacity: 0.7; box-shadow: 0 0 5px rgba(255, 255, 255, 0.3); }
        td { border: 1px solid black; padding: 2px; text-align: center; overflow: hidden; text-overflow: ellipsis; max-height: 20px; overflow-y: auto; white-space: normal; font-weight: bold; color: #000000; background-color: #ffffff; }
        td.numero { 
            width: 40px; 
            max-width: 40px; 
            font-size: 30px; 
            line-height: 1; 
        }
        td.numero-violento { color: #FF0000; }
        td.numero-propiedad { color: #0000FF; }
        td.numero-frustrado { color: #800000; }
        td.clasificacion { width: 70px; max-width: 70px; }
        td.delito { width: 80px; max-width: 80px; }
        td.fecha { width: 50px; max-width: 50px; white-space: nowrap; }
        td.dia { width: 50px; max-width: 50px; white-space: nowrap; }
        td.hora { width: 35px; max-width: 35px; white-space: nowrap; }
        td.rango-hora { width: 70px; max-width: 70px; }
        td.lugar { width: 70px; max-width: 70px; }
        td.direccion { width: 80px; max-width: 80px; }
        td.circunstancias { width: 400px; max-width: 400px; }
        td.cuadrante { width: 50px; max-width: 50px; white-space: nowrap; }
        td.numero-parte { width: 70px; max-width: 70px; white-space: nowrap; }
        td.accion { width: 35px; max-width: 35px; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        tr.selected { background-color: #cce5ff; }
        .edit-btn { padding: 2px 5px; cursor: pointer; font-size: 7px; background-color: #28a745; color: white; border: none; border-radius: 3px; font-weight: bold; }
        .edit-btn:hover { background-color: #218838; }
        .error { color: #dc3545; font-size: 12px; margin-top: 5px; }
        #loadingSpinner { background: rgba(0, 0, 0, 0.1); border-radius: 5px; text-align: center; padding: 20px; display: none; }
        #loadingSpinner span { font-size: 12px; font-weight: bold; }
        .table-controls { display: flex; align-items: center; }
        .pagination { display: flex; gap: 5px; align-items: center; margin-left: 10px; }
        .pagination button { padding: 5px 8px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; font-weight: bold; font-size: 10px; }
        .pagination button:disabled { cursor: not-allowed; opacity: 0.5; background-color: #6c757d; }
        .pagination button:hover:not(:disabled) { background-color: #0056b3; }
        .pagination span { font-size: 10px; color: #000; }
        .leaflet-tooltip { font-weight: bold; font-size: 20px; color: #000; background-color: rgba(255, 255, 255, 0.8); border: none; }
        .number-label {
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            color: #000;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            padding: 2px;
            border: 1px solid #000;
        }
        .time-label {
            font-size: 8px;
            font-weight: bold;
            text-align: center;
            color: #fff;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 2px;
            padding: 1px 3px;
            border: 1px solid #000;
        }
        @media (max-width: 768px) {
            .container { flex-direction: column; height: auto; }
            #main-content { width: 100%; }
            #sidebar { 
                width: 100%; 
                height: auto; 
                position: static; 
                transform: none; 
                box-shadow: none; 
                padding: 10px; 
            }
            #sidebar.visible { transform: none; }
            .table-container { 
                position: static; 
                width: 100%; 
                max-height: 300px; 
                box-shadow: none; 
                border: none; 
                border-radius: 0; 
            }
            table { font-size: 7px; }
            th, td { padding: 1px; }
            td { max-width: 50px; max-height: 15px; }
            td.numero { width: 30px; max-width: 30px; font-size: 22px; }
            td.clasificacion, td.rango-hora, td.lugar, td.numero-parte { width: 50px; max-width: 50px; }
            td.delito, td.direccion { width: 60px; max-width: 60px; }
            td.fecha, td.dia, td.cuadrante { width: 40px; max-width: 40px; }
            td.hora, td.accion { width: 25px; max-width: 25px; }
            td.circunstancias { width: 300px; max-width: 300px; }
            .edit-btn { font-size: 6px; padding: 1px 4px; }
            .filter-container { flex-direction: column; }
            #map { height: 400px; }
            .pagination { flex-direction: row; gap: 5px; }
            .pagination button { padding: 4px 6px; font-size: 9px; }
            .pagination span { font-size: 9px; }
            .leaflet-tooltip { font-size: 16px; }
            .number-label { font-size: 10px; icon-size: [16, 16]; }
            .time-label { font-size: 6px; icon-size: [24, 12]; }
        }
        @media (max-width: 480px) {
            table { font-size: 6px; }
            th, td { padding: 1px; }
            th { cursor: default; }
            td { max-width: 40px; max-height: 12px; }
            td.numero { width: 20px; max-width: 20px; font-size: 16px; }
            td.clasificacion, td.rango-hora, td.lugar, td.numero-parte { width: 40px; max-width: 40px; }
            td.delito, td.direccion { width: 50px; max-width: 50px; }
            td.fecha, td.dia, td.cuadrante { width: 30px; max-width: 30px; }
            td.hora, td.accion { width: 20px; max-width: 20px; }
            td.circunstancias { width: 200px; max-width: 200px; }
            .edit-btn { font-size: 5px; padding: 1px 3px; }
            .leaflet-tooltip { font-size: 14px; }
            .number-label { font-size: 8px; icon-size: [12, 12]; }
            .time-label { font-size: 5px; icon-size: [20, 10]; }
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
    </style>
</head>
<body>
    <div class="header-section">
        <h1>PANORAMA DE LOS ROBOS</h1>
        <div class="subtitle-section" id="subtitle-cuadrante"></div>
        <div class="subtitle-section" id="subtitle-date"></div>
    </div>
    <div class="container">
        <div id="main-content">
            <div class="map-container">
                <div id="map-loading">Cargando mapa...</div>
                <div id="map" style="display: none;" role="region" aria-label="Mapa interactivo de delitos"></div>
            </div>
            <div class="table-container">
                <div class="drag-handle">
                    <span>Lista de Casos</span>
                    <div class="table-controls">
                        <div class="pagination">
                            <button onclick="changePage(-1)" disabled id="prevPage" aria-label="Página anterior">Anterior</button>
                            <span id="pageInfo">Página 1 de 1</span>
                            <button onclick="changePage(1)" disabled id="nextPage" aria-label="Página siguiente">Siguiente</button>
                        </div>
                    </div>
                </div>
                <div class="form-container">
                    <table id="casesTable" aria-describedby="casesTableCaption">
                        <caption id="casesTableCaption" class="sr-only">Lista de casos de delitos</caption>
                        <thead>
                            <tr>
                                <th data-col="numero">Nº</th>
                                <th data-col="clasificacion">Clasificación</th>
                                <th data-col="delito">Delito</th>
                                <th data-col="fecha">Fecha</th>
                                <th data-col="dia">Día</th>
                                <th data-col="hora">Hora</th>
                                <th data-col="rango-hora">Rango Hora</th>
                                <th data-col="lugar">Lugar</th>
                                <th data-col="direccion">Dirección</th>
                                <th data-col="circunstancias">Circunstancias</th>
                                <th data-col="cuadrante">Cuadrante</th>
                                <th data-col="numero-parte">Número Parte</th>
                                <th data-col="accion">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="casesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="sidebar">
            <div class="form-container">
                <label for="fileInput">Cargar archivo Excel (.xlsx):</label>
                <input type="file" id="fileInput" accept=".xlsx" style="display: none;" aria-describedby="fileInputHelp" />
                <button onclick="document.getElementById('fileInput').click()" aria-label="Abrir y cargar archivo Excel">Abrir y Cargar Delitos.xlsx</button>
                <small id="fileInputHelp" class="sr-only">Seleccione un archivo Excel con datos de delitos</small>
                <p id="errorMessage" class="error"></p>
            </div>
            <div class="form-container">
                <label for="mapProvider">Seleccionar Cartografía:</label>
                <select id="mapProvider" onchange="changeMapProvider()" aria-label="Seleccionar proveedor de mapa">
                    <option value="osm">OpenStreetMap (Calles)</option>
                    <option value="carto">Carto Light</option>
                    <option value="stamen">Stamen Terrain</option>
                    <option value="esri_street">Esri WorldStreetMap (Calles)</option>
                    <option value="esri_imagery">Esri WorldImagery</option>
                    <option value="opentopo">OpenTopoMap</option>
                    <option value="thunderforest">Thunderforest Outdoors (Calles)</option>
                    <option value="cyclosm">CyclOSM</option>
                    <option value="mapbox">Mapbox Streets (Calles)</option>
                    <option value="carto_dark">Carto Dark (High Contrast)</option>
                    <option value="waze_traffic">Waze (Tráfico y Calles)</option>
                    <option value="esri_topo">Esri WorldTopoMap (Calles)</option>
                    <option value="mapbox_satellite_streets">Mapbox Satellite Streets (Calles)</option>
                    <option value="google_street">Google Maps Streets (Calles)</option>
                    <option value="google_hybrid">Google Maps Hybrid (Calles)</option>
                    <option value="ign_spain">IGN Spain (Calles y Numeración)</option>
                    <option value="buenos_aires">Buenos Aires Mapa Interactivo (Calles y Numeración)</option>
                </select>
            </div>
            <div class="form-container">
                <h3>Filtrar Casos</h3>
                <form id="filterForm" class="filter-container">
                    <div>
                        <label for="startDate">Fecha Inicio:</label>
                        <input type="date" id="startDate" aria-describedby="startDateHelp" />
                        <small id="startDateHelp" class="sr-only">Seleccione la fecha de inicio para el filtro</small>
                    </div>
                    <div>
                        <label for="endDate">Fecha Fin:</label>
                        <input type="date" id="endDate" aria-describedby="endDateHelp" />
                        <small id="endDateHelp" class="sr-only">Seleccione la fecha de fin para el filtro</small>
                    </div>
                    <div>
                        <label for="delitoFilter">Delito:</label>
                        <select id="delitoFilter" aria-describedby="delitoFilterHelp">
                            <option value="">Todos</option>
                        </select>
                        <small id="delitoFilterHelp" class="sr-only">Seleccione un delito para filtrar</small>
                    </div>
                    <div>
                        <label for="rangoHoraFilter">Rango Hora:</label>
                        <select id="rangoHoraFilter" aria-describedby="rangoHoraFilterHelp">
                            <option value="">Todos</option>
                        </select>
                        <small id="rangoHoraFilterHelp" class="sr-only">Seleccione un rango horario para filtrar</small>
                    </div>
                    <div>
                        <label for="cuadranteFilter">Cuadrante:</label>
                        <select id="cuadranteFilter" aria-describedby="cuadranteFilterHelp">
                            <option value="">Todos</option>
                        </select>
                        <small id="cuadranteFilterHelp" class="sr-only">Seleccione un cuadrante para filtrar</small>
                    </div>
                    <div>
                        <label for="textFilter">Búsqueda Textual:</label>
                        <input type="text" id="textFilter" placeholder="Ej: Vehículo rojo" aria-describedby="textFilterHelp" />
                        <small id="textFilterHelp" class="sr-only">Ingrese texto para buscar en la columna Circunstancias</small>
                    </div>
                    <button type="submit" aria-label="Aplicar filtros">Filtrar</button>
                    <button type="button" onclick="resetFilter()" aria-label="Restablecer filtros">Restablecer</button>
                </form>
            </div>
            <div class="form-container">
                <h3>Añadir/Editar Delito</h3>
                <form id="pointForm">
                    <input type="hidden" id="editIndex" />
                    <label for="lat">Latitud:</label>
                    <input type="number" step="any" id="lat" placeholder="-36.8400" required aria-describedby="latHelp" />
                    <small id="latHelp" class="sr-only">Ingrese la latitud (entre -90 y 90)</small>
                    <label for="lng">Longitud:</label>
                    <input type="number" step="any" id="lng" placeholder="-73.1100" required aria-describedby="lngHelp" />
                    <small id="lngHelp" class="sr-only">Ingrese la longitud (entre -180 y 180)</small>
                    <button type="submit" aria-label="Guardar delito">Guardar Delito</button>
                </form>
            </div>
            <div class="form-container">
                <button onclick="downloadCSV()" aria-label="Descargar datos como CSV">Descargar CSV</button>
            </div>
            <div id="loadingSpinner">
                <span>Cargando...</span>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="js/script.js"></script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93d1cb14bd60add7',t:'MTc0Njc5OTk2Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93dc963028a07bc9',t:'MTc0NjkxMzEzOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>